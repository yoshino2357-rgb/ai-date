<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ç†è§£åº¦ã¾ã¨ã‚</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-8">
  <div class="max-w-7xl mx-auto">
    <div class="bg-white rounded-2xl shadow-xl p-8 mb-8">
      <h1 class="text-4xl font-bold text-gray-800 mb-2">ç†è§£åº¦ã¾ã¨ã‚</h1>
      <div class="flex gap-4 items-center">
        <label class="flex-1">
          <input type="file" accept=".xlsx,.xls,.pdf" id="file-upload" class="hidden" />
          <div id="upload-btn" class="cursor-pointer bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg text-center font-semibold transition-colors">
            ğŸ“ Excel/PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
          </div>
        </label>
        <button id="reset-btn" class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-lg font-semibold transition-colors hidden">
          ğŸ—‘ï¸ ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ
        </button>
      </div>
      <p class="text-sm text-gray-500 mt-4">
        âš ï¸ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ‡ãƒ¼ã‚¿ã¯ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã¾ã™
      </p>
      <div id="status" class="mt-4 text-sm font-semibold"></div>
    </div>
    <div id="summary"></div>
    <div id="questions"></div>
    <div id="no-data" class="bg-white rounded-2xl shadow-xl p-12 text-center">
      <div class="text-6xl mb-4">ğŸ“Š</div>
      <h3 class="text-2xl font-bold text-gray-800 mb-2">ãƒ‡ãƒ¼ã‚¿ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“</h3>
      <p class="text-gray-600">ä¸Šã®ãƒœã‚¿ãƒ³ã‹ã‚‰Excel/PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„</p>
    </div>
  </div>

  <script>
    // PDF.js ã®è¨­å®š
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    const COLORS = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16'];

    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
    function showStatus(message, type = 'info') {
      const status = document.getElementById('status');
      const colors = {
        info: 'text-blue-600',
        success: 'text-green-600',
        error: 'text-red-600'
      };
      status.className = `mt-4 text-sm font-semibold ${colors[type]}`;
      status.textContent = message;
    }

    // localStorageã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    function loadSurveyData() {
      const data = localStorage.getItem('survey-data');
      return data ? JSON.parse(data) : null;
    }

    // localStorageã«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
    function saveSurveyData(data) {
      localStorage.setItem('survey-data', JSON.stringify(data));
      showStatus('âœ… ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†ï¼', 'success');
      renderUI();
    }

    // ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ
    function resetSurveyData() {
      localStorage.removeItem('survey-data');
      showStatus('âœ… ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ', 'success');
      renderUI();
    }

    // PDFãƒ‡ãƒ¼ã‚¿ã®å‡¦ç†
    async function processPDFData(file) {
      const arrayBuffer = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
      
      let fullText = '';
      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const textContent = await page.getTextContent();
        const pageText = textContent.items.map(item => item.str).join(' ');
        fullText += pageText + '\n';
      }
      
      // ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰è¡¨å½¢å¼ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡ºï¼ˆç°¡æ˜“ç‰ˆï¼‰
      const lines = fullText.split('\n').filter(line => line.trim());
      
      // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’æ¤œå‡ºï¼ˆè³ªå•ã‚’å«ã‚€è¡Œï¼‰
      let headerIndex = -1;
      let headers = [];
      
      for (let i = 0; i < Math.min(20, lines.length); i++) {
        const line = lines[i];
        // è³ªå•ã‚‰ã—ã„è¡Œã‚’æ¤œå‡º
        if (line.includes('Q') || line.includes('è³ªå•') || line.includes('?') || line.includes('ã€‚')) {
          // ã‚¹ãƒšãƒ¼ã‚¹ã‚„ã‚¿ãƒ–ã§åˆ†å‰²ã—ã¦ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’æŠ½å‡º
          const parts = line.split(/\s+/).filter(p => p.length > 2);
          if (parts.length > 0) {
            headers = parts;
            headerIndex = i;
            break;
          }
        }
      }
      
      // ãƒ˜ãƒƒãƒ€ãƒ¼ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ã€æœ€åˆã®è¡Œã‚’ãƒ˜ãƒƒãƒ€ãƒ¼ã¨ã™ã‚‹
      if (headerIndex === -1) {
        headers = lines[0].split(/\s+/).filter(p => p.trim());
        headerIndex = 0;
      }
      
      // ãƒ‡ãƒ¼ã‚¿è¡Œã‚’æŠ½å‡º
      const dataLines = lines.slice(headerIndex + 1);
      const jsonData = [];
      
      for (const line of dataLines) {
        if (line.trim()) {
          const values = line.split(/\s+/).filter(v => v.trim());
          if (values.length > 0) {
            const row = {};
            headers.forEach((header, idx) => {
              row[header] = values[idx] || '';
            });
            jsonData.push(row);
          }
        }
      }
      
      // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ã€ãƒ†ã‚­ã‚¹ãƒˆå…¨ä½“ã‚’1ã¤ã®è³ªå•ã¨ã—ã¦æ‰±ã†
      if (jsonData.length === 0) {
        return {
          totalSubmissions: 1,
          uploadDate: new Date().toLocaleString('ja-JP'),
          questions: [{
            question: 'PDFã®å†…å®¹',
            totalResponses: 1,
            chartData: [{
              name: 'ãƒ†ã‚­ã‚¹ãƒˆæŠ½å‡ºå®Œäº†',
              fullName: fullText.substring(0, 200) + '...',
              count: 1,
              percentage: '100.0'
            }],
            answerCounts: { [fullText]: 1 }
          }]
        };
      }
      
      return processExcelData(jsonData);
    }

    // Excelãƒ‡ãƒ¼ã‚¿ã®å‡¦ç†
    function processExcelData(rawData) {
      const columns = Object.keys(rawData[0]);
      const questions = columns.filter(col =>
        !col.includes('ID') &&
        !col.includes('é–‹å§‹æ™‚åˆ»') &&
        !col.includes('å®Œäº†æ™‚åˆ»') &&
        !col.includes('é›»å­ãƒ¡ãƒ¼ãƒ«') &&
        !col.includes('åå‰')
      );
      const aggregated = questions.map(question => {
        const answers = rawData.map(row => row[question]).filter(a => a !== null && a !== undefined && a !== '');
        const answerCounts = {};
        answers.forEach(answer => {
          const key = String(answer).trim();
          answerCounts[key] = (answerCounts[key] || 0) + 1;
        });
        const chartData = Object.entries(answerCounts)
          .map(([answer, count]) => ({
            name: answer.length > 30 ? answer.substring(0, 30) + '...' : answer,
            fullName: answer,
            count: count,
            percentage: ((count / answers.length) * 100).toFixed(1)
          }))
          .sort((a, b) => b.count - a.count);
        return {
          question,
          totalResponses: answers.length,
          chartData,
          answerCounts
        };
      });
      return {
        totalSubmissions: rawData.length,
        uploadDate: new Date().toLocaleString('ja-JP'),
        questions: aggregated
      };
    }

    // UIæç”»
    function renderUI() {
      const data = loadSurveyData();
      const summary = document.getElementById('summary');
      const questions = document.getElementById('questions');
      const noData = document.getElementById('no-data');
      const resetBtn = document.getElementById('reset-btn');
      summary.innerHTML = '';
      questions.innerHTML = '';
      if (!data) {
        noData.style.display = '';
        resetBtn.classList.add('hidden');
        return;
      }
      noData.style.display = 'none';
      resetBtn.classList.remove('hidden');
      
      // æ¦‚è¦
      summary.innerHTML = `
        <div class="bg-white rounded-2xl shadow-xl p-8 mb-8">
          <h2 class="text-2xl font-bold text-gray-800 mb-4">ğŸ“ˆ æ¦‚è¦</h2>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="bg-blue-50 p-6 rounded-xl">
              <div class="text-sm text-blue-600 font-semibold mb-1">ç·å›ç­”æ•°</div>
              <div class="text-4xl font-bold text-blue-700">${data.totalSubmissions}</div>
            </div>
            <div class="bg-green-50 p-6 rounded-xl">
              <div class="text-sm text-green-600 font-semibold mb-1">è³ªå•æ•°</div>
              <div class="text-4xl font-bold text-green-700">${data.questions.length}</div>
            </div>
            <div class="bg-purple-50 p-6 rounded-xl">
              <div class="text-sm text-purple-600 font-semibold mb-1">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ—¥æ™‚</div>
              <div class="text-lg font-bold text-purple-700">${data.uploadDate}</div>
            </div>
          </div>
        </div>
      `;
      
      // è³ªå•ã”ã¨ã®è¡¨ç¤º
      data.questions.forEach((q, idx) => {
        const qDiv = document.createElement('div');
        qDiv.className = "bg-white rounded-2xl shadow-xl p-8 mb-8";
        qDiv.innerHTML = `
          <h3 class="text-xl font-bold text-gray-800 mb-2">Q${idx + 1}. ${q.question}</h3>
          <p class="text-gray-600 mb-6">å›ç­”æ•°: ${q.totalResponses}ä»¶</p>
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div>
              <h4 class="font-semibold text-gray-700 mb-4">æ£’ã‚°ãƒ©ãƒ•</h4>
              <canvas id="bar-${idx}" height="300"></canvas>
            </div>
            <div>
              <h4 class="font-semibold text-gray-700 mb-4">å††ã‚°ãƒ©ãƒ•</h4>
              <canvas id="pie-${idx}" height="300"></canvas>
            </div>
          </div>
          <div class="mt-6">
            <h4 class="font-semibold text-gray-700 mb-3">è©³ç´°ãƒ‡ãƒ¼ã‚¿</h4>
            <div class="overflow-x-auto">
              <table class="w-full text-left border-collapse">
                <thead>
                  <tr class="bg-gray-100">
                    <th class="border p-3 font-semibold">å›ç­”</th>
                    <th class="border p-3 font-semibold">ä»¶æ•°</th>
                    <th class="border p-3 font-semibold">å‰²åˆ</th>
                  </tr>
                </thead>
                <tbody>
                  ${q.chartData.map(item => `
                    <tr class="hover:bg-gray-50">
                      <td class="border p-3">${item.fullName}</td>
                      <td class="border p-3">${item.count}</td>
                      <td class="border p-3">${item.percentage}%</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
        `;
        questions.appendChild(qDiv);
        
        // æ£’ã‚°ãƒ©ãƒ•
        new Chart(document.getElementById(`bar-${idx}`), {
          type: 'bar',
          data: {
            labels: q.chartData.map(d => d.name),
            datasets: [{
              label: 'ä»¶æ•°',
              data: q.chartData.map(d => d.count),
              backgroundColor: COLORS,
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const i = context.dataIndex;
                    return `${q.chartData[i].fullName}: ${q.chartData[i].count}ä»¶ (${q.chartData[i].percentage}%)`;
                  }
                }
              }
            },
            scales: {
              x: { ticks: { autoSkip: false, maxRotation: 45, minRotation: 45 } }
            }
          }
        });
        
        // å††ã‚°ãƒ©ãƒ•
        new Chart(document.getElementById(`pie-${idx}`), {
          type: 'pie',
          data: {
            labels: q.chartData.map(d => d.name),
            datasets: [{
              data: q.chartData.map(d => d.count),
              backgroundColor: COLORS,
            }]
          },
          options: {
            responsive: true,
            plugins: {
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const i = context.dataIndex;
                    return `${q.chartData[i].fullName}: ${q.chartData[i].count}ä»¶ (${q.chartData[i].percentage}%)`;
                  }
                }
              }
            }
          }
        });
      });
    }

    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    document.getElementById('upload-btn').onclick = () => {
      document.getElementById('file-upload').click();
    };
    
    document.getElementById('file-upload').onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      const uploadBtn = document.getElementById('upload-btn');
      uploadBtn.textContent = 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...';
      showStatus('â³ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†ä¸­...', 'info');
      
      try {
        let processedData;
        
        // ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã«å¿œã˜ã¦å‡¦ç†ã‚’åˆ†å²
        if (file.name.endsWith('.pdf')) {
          processedData = await processPDFData(file);
        } else {
          // Excelãƒ•ã‚¡ã‚¤ãƒ«ã®å‡¦ç†
          const data = await file.arrayBuffer();
          const workbook = XLSX.read(data);
          const worksheet = workbook.Sheets[workbook.SheetNames[0]];
          const jsonData = XLSX.utils.sheet_to_json(worksheet);
          
          if (jsonData.length === 0) {
            alert('ãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™');
            uploadBtn.textContent = 'ğŸ“ Excel/PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰';
            showStatus('', 'info');
            return;
          }
          
          processedData = processExcelData(jsonData);
        }
        
        saveSurveyData(processedData);
      } catch (error) {
        alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        showStatus('âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
        console.error(error);
      }
      
      uploadBtn.textContent = 'ğŸ“ Excel/PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰';
    };

    // ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ
    document.getElementById('reset-btn').onclick = () => {
      if (confirm('æœ¬å½“ã«ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹?')) {
        resetSurveyData();
      }
    };

    // åˆæœŸè¡¨ç¤º
    renderUI();
  </script>
</body>
</html>
